--- 
title: "Prevalence and Effects of Lead in NYC's Water System"
author: "Tianchun Huang, Erdong Wang, Jiaxi Zhou"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---
--- 
title: "Prevalence and Effects of Lead in NYC's Water System"
author: "Tianchun Huang, Erdong Wang, Jiaxi Zhou"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---
```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

# Introduction
Lead contamination in drinking water is a serious issue for New York residents. Although NYC Environmental Protection Agency promised that the water is virtually lead-free when delivered from reservoir system, the water out of the tap can still contain lead by absorbing it from pipes and fixtures. Therefore, New York residents are potentially exposed to the threat of lead poisoning caused by lead in drinking water. 

Lead poisoning can be harmful to humans in many ways, especially in kidneys and nervous system, even cancer. Lead is also dangerous to growing up children by putting them into risks of future diseases and health problems. In this project, we are going to analysis the prevalence of lead contamination in New York water system, how it affects children in lead poisoning and how the two are related. We are going to present our analysis by answering the following three questions:

1. Lead in at-the-tap water - How prevalent is lead in NYC water system? Which part of the city has most serious health risk caused by lead in water?

2. Lead in children's blood - How are children in NYC affected by lead poisoning?

3. Relationship - Is there any relationship between the lead in NYC water system and the lead level in children's blood?



<!--chapter:end:index.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data sources

Four datasets are collected from NYC OpenData, a free public data published by New York City agencies and other organizations. We chose this website because it provides the public with reliable data sources used by New York City government. The datasets include Free Residential at-the-tap Lead and Copper Data, Compliance at-the-tap Lead and Copper Data,Children Tested for Lead by Age 3, and Children Under 6 yrs with Elevated Blood Lead Levels (BLL). The two datasets on lead and copper data are provided by Department of Environmental Protection (DEP), and the other two on children are provided by Department of Health and Mental Hygiene. These datasets help examine the tap water quality in NYC and how children are affected by lead in NYC.

## Free Residential at-the-tap Lead and Copper Data 
It is created on February 23, 2018 and last updated on February 8, 2020. Data are collected through Free Residential (FR) at-the-tap lead testing program, which is offered to any resident in NYC upon request. Residents collect all samples using a sampling kit provided by DEP and each record provides the at-the-tap lead and copper concentrations for a specific location collected on the data noted. The variables of the dataset include kit ID, borough and zipcode where sample was collected, date collected, date received by DEP, concentration of lead in the first draw sample, in the 1-2 minute flush sample, and in the 5 minute flush sample, concentration of copper in the first draw sample, in the 1-2 minute flush sample, and in the 5 minute flush sample. Concentration is reported as milligrams per liter (mg/L). There are 19k records in this dataset. Some potential issues with the data are: 1. The concentration of lead and copper in 5 minute flush sample has lots of missing values, which impedes accurate analysis; 2. The locations of samples collected are not precise enough for further analysis.

## Compliance at-the-tap Lead and Copper Data
It is created on February 24, 2018 and last updated on February 8, 2020. Data are collected under the federal Lead and Copper Rule for compliance. Residents collect all samples using a sampling kit provided by DEP and each record provides the at-the-tap lead and copper concentrations for a specific location collected on the data noted to assess the effectiveness of corrosion control. The variables include kit ID, borough and zipcode of location where sample was collected, date collected, date received by DEP, concentration of lead in the first draw sample, and concentration of copper in the first draw sample. Concentration is reported as micrograms per liter (\mu g/L). There are 2460 records in the dataset. There is one wrong record of borough in the dataset, which needs to be ignored during analysis.

## Children Tested for Lead by Age 3 
It is created on July 10, 2018 and last updated on February 8, 2020. These data are an indicator of the number and percentage of children turning 3 years old in a given year who were tested for lead poisoning. The variables are geo_type, geo_area_id, geo_area_name, borough_id, time_period, children tested for lead by age 3 years Number, corresponding notes, children tested for lead by age 3 years Percentage, and corresponding notes. The geo_type is the type of geographic aggregation for the data, including neighborhood, borough, and citywide. The geo_area_id is an ID for the geographic neighborhood, and geo_area_name is the neighborhood name for the geographic division. Among the variables, geo_area_id, children tested for lead by age 3 years Number and Percentage are numbers, while the rest are all plain text. There are 432 records in this dataset. 

## Children Under 6 yrs with Elevated Blood Lead Levels (BLL)
It is created on July 10, 2018 and last updated on February 8, 2020. These data are an indicator of children younger thant 6 years old tested in NYC in a given year with blood lead levels of 5 mcg/dL or greater. The variables are geo_type, geo_area_id, geo_area_name, borough_id, time_period, children under 6 years with elevated blood lead levels (BLL) Number BLL >= 5\mu g/dL, Number BLL >= 10\mu g/dL, Number BLL >= 15\mu g/dL, Number Tested, Rate BLL >= 5\mu g/dL per 1,000 tested, Rate BLL >= 10\mu g/dL per 1,000 tested, Rate BLL >= 15\mu g/dL per 1,000 tested, and corresponding notes. The geo_type, geo_area_id, geo_area_name, borough_id, time_period are same as those in `Children Tested for Lead by Age 3`. There are 576 records in the dataset. One potential issue is the bias caused by total number of children tested vary a lot across NYC.

<!--chapter:end:02-data.Rmd-->


# Data transformation

Placeholder


## Data loading and cleaning
## Data preprocessing
## Compute ratio of samples exceeding safety threshold and group by zipcode
## Join at-the-tap water data and children data

<!--chapter:end:03-cleaning.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Missing values
```{r warning=FALSE}
Free_Residential_at_the_tap_Lead_and_Copper_Data<-read.csv("Free_Residential_at-the-tap_Lead_and_Copper_Data.csv")
extracat::visna(Free_Residential_at_the_tap_Lead_and_Copper_Data, sort = "b")

```
```{r, warning=FALSE}
Children_Under_6_yrs_with_Elevated_Blood_Lead_Levels__BLL_ <- read.csv("Children_Under_6_yrs_with_Elevated_Blood_Lead_Levels__BLL_.csv")
extracat::visna(Children_Under_6_yrs_with_Elevated_Blood_Lead_Levels__BLL_, sort = "b")
```

We have four datasets in total. In the "Compliance at-the-tap Lead and Copper" dataset, there is no missing value. In the "Children Tested for Lead by Age 3" dataset, the only two variables that have missing values are `Children.tested.for.lead.by.age.3.years.Number._NOTES` and `Children.tested.for.lead.by.age.3.years.Percentage._NOTES`. In fact all the data values in these two variables are missing. These two variables are supposed to store additional notes apply to the other two variables. The reason for the missing values might be that the notes are totally unnecessary. We may delete these two columns.

The other two datasets have missing values which show some distribution patterns so we will make visna plots to analysis it. From the first plot, we see that in "Free Residential at-the-tap Lead and Copper" dataset, there are 6 columns that have missing values. Most rows miss data from the variable `Lead.5.Minute.Flush..mg.L.` and `Copper.5.minute.Flush..mg.L.`. These two variables store the concentration of lead and copper in the 5 minute flush sample. Since all the water samples are collected by residents using sampling kits provided by DEP, the reason for the missing value might be that most residents are unwilling to waste time and water to keep the tap opening for 5 minutes. Very few rows have missing values in other variables and the pattern is random. In the "Children Under 6 yrs with Elevated Blood Lead Levels", the variable `Children.under.6.years.with.elevated.blood.lead.levels..BLL..Number.Tested._NOTES` has missing values in all rows. We can just delete all columns with 'notes' since they are meaning less to our analysis. There are also some missing values in the variable `borough_id`. In each row with the missing value, the `geo_area_name` is `New York City`. We can conclude that they did not assign a borough id to New York City.

<!--chapter:end:04-missing.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Results
```{r}
library(tidyverse)
library(dplyr)
library(ggridges)
```

## How prevalent is lead in NYC water system?
```{r, warning=FALSE, message=FALSE}
free_residential <- read.csv("free_residential.csv")
compliance <- read.csv("compliance.csv")
children_6_yrs <- read.csv("Children_Under_6_yrs_with_Elevated_Blood_Lead_Levels__BLL_.csv")
lead_free <- free_residential %>%
  select(Date.Collected, First.Draw.at.the.tap.Lead.level..Âµg.l., Lead.1.2.Minute.Flush..mg.L.) %>%
  mutate(year = substr(Date.Collected, 7, 10), over_threshold = (First.Draw.at.the.tap.Lead.level..Âµg.l. > 0.015 |  Lead.1.2.Minute.Flush..mg.L. > 0.015)) %>%
  select(year, over_threshold) %>%
  group_by(year, over_threshold) %>%
  summarise(count = n()) %>%
  na.omit %>%
  group_by(year) %>%
  mutate(total = sum(count)) %>%
  filter(over_threshold == TRUE) %>%
  mutate(ratio = count / total) %>%
  select(year, ratio) %>%
  mutate(type = "Percentage of water samples containing lead over threshold(Free-residential)")

lead_compliance <- compliance %>%
  select(Date.Collected, First.Draw.at.the.tap.Lead.level..mg.l.) %>%
  mutate(year = substr(Date.Collected, 7, 10), over_threshold = (First.Draw.at.the.tap.Lead.level..mg.l. > 0.015 )) %>%
  select(year, over_threshold) %>%
  group_by(year, over_threshold) %>%
  summarise(count = n()) %>%
  na.omit %>%
  group_by(year) %>%
  mutate(total = sum(count)) %>%
  filter(over_threshold == TRUE) %>%
  mutate(ratio = count / total) %>%
  select(year, ratio) %>%
  mutate(type = "Percentage of water samples containing lead over threshold(Compliance)")

combined <- rbind(lead_free, lead_compliance)
ggplot(data = combined, aes(fill= type, x = year, y=ratio)) +
 geom_bar(stat="identity", position = "dodge") +
 theme(legend.position="bottom") +
 guides(fill = guide_legend(nrow = 2)) +
 ggtitle("Prevalence of Lead in At-the-tap Water") +
 theme(plot.title = element_text(lineheight=.8, face="bold"))
```

We studied two datasets for prevalence of lead in at-the-tap water. One is from water samples tested under compliance, marked as red, and the other is tested upon residents' request, marked as blue.

According to EPA(Environmental Protection Agency), the maximum allowable concentration of lead in drinking water is 15 µg/L. The grouped bar chart shows the percentage of water sample containing lead over the threshold(15 µg/L) every year from 2014 to 2019. From the chart, we can observe that percentage of water samples containing lead over15 µg/L from both compliance and residents decreased by year. The decrease of contaminated percentage is more remarkable in free-residential water samples, with almost half drop from year 2015 to year 2016. The reason might be that the government has been addressing the issue of lead-contaminated water more seriously and the technology improved the effect of drinking water purifying. However, by the end of year 2019, the percentage of water samples containing lead over the threshold from residents is still over 3.8% and that from compliance is even higher, over 5%. The issue of lead-contaminated water still presents and it poses a strong threat to citizens' health.


```{r, warning=FALSE, message=FALSE, results=FALSE}
lead_con <- free_residential %>%
  select( First.Draw.at.the.tap.Lead.level..Âµg.l., Lead.1.2.Minute.Flush..mg.L.) %>%
  na.omit %>%
  rename(first.draw = First.Draw.at.the.tap.Lead.level..Âµg.l., "1-2.minute.draw" = Lead.1.2.Minute.Flush..mg.L. ) %>%
  pivot_longer(cols = everything(), names_to = "Density", values_to = "Lead Concentration(mg/L)") %>%
  filter(`Lead Concentration(mg/L)` < 0.01)

ggplot(lead_con, aes(x = `Lead Concentration(mg/L)`, y = Density)) + 
  geom_density_ridges_gradient(fill = "#00AFBB") +
  theme_ridges() +
  ggtitle("Compare Lead Concentration between First-draw Sample \n and 1-2-minute-flush Sample") +
  theme(plot.title = element_text(lineheight=.8, face="bold", hjust = 0.5))
  

```

Since lead in water seems inevitable in New York, we are finding a way to reduce the lead concentration in our drinking water as much as possible. Minnesota Department of Health suggested that we should let the water run for some time before using water for drinking and cooking. They stated that it is an efficient way to reduce our exposure to lead in water because the more time water has been staying in pipes, the higher the lead concentration it. 

We use the "Free Residential at-the-tap Lead and Copper Data" dataset to test this hypothesis. Each residential volunteer submitted two water samples: one is collected right after the tap is opened and the other is collected after the tap has flushed for 1-2 minutes. We use a ridgeline plot to compare the lead concentration between two types of water samples. The plot gives us two density curves with lead concentration of water samples on the x-axis and density on the y-axis, one for first draw samples and the other for 1-2 minute draw. We can observe that among 1-2 minutes draw samples,the percentage of water samples with lead concentration around 0 is higher than that of first draw samples. On the contrary, the percentage of water samples with large lead concentration is higher in 1-2 minutes draw samples. Therefore, we can conclude that lead concentration in water will decrease as the tap is opening and we can reduce our exposure to lead in drinking water by waiting for some time after opening the tap. 

## How are children in NYC affected by lead poisoning?
```{r, warning=FALSE, message=FALSE}
children_bar <- children_6_yrs %>% rename(`5 <= BLL <10 (mcg/dL)` = Children.under.6.years.with.elevated.blood.lead.levels..BLL..Rate..BLL..5.Âµg.dL.per.1.000.tested, `10 <= BLL <15 (mcg/dL)` = Children.under.6.years.with.elevated.blood.lead.levels..BLL..Rate.BLL..10.Âµg.dL.per.1.000.tested, `BLL >=15 (mcg/dL)` = Children.under.6.years.with.elevated.blood.lead.levels..BLL..Rate.BLL..15.Âµg.dL.per.1.000.tested) %>%
  rename(year = time_period) %>%
  mutate(year = as.character(year)) %>%
  filter(geo_type =="Citywide") %>%
  select(year, `5 <= BLL <10 (mcg/dL)`, `10 <= BLL <15 (mcg/dL)`, `BLL >=15 (mcg/dL)`) %>%
  na.omit %>%
  group_by(year) %>% 
  summarise(`5 <= BLL <10 (mcg/dL)` = sum(`5 <= BLL <10 (mcg/dL)`), `10 <= BLL <15 (mcg/dL)` = sum(`10 <= BLL <15 (mcg/dL)`), `BLL >=15 (mcg/dL)` = sum(`BLL >=15 (mcg/dL)`)) %>% 
  mutate(`5 <= BLL <10 (mcg/dL)` = `5 <= BLL <10 (mcg/dL)` - `10 <= BLL <15 (mcg/dL)`, `10 <= BLL <15 (mcg/dL)` = `10 <= BLL <15 (mcg/dL)` - `BLL >=15 (mcg/dL)`) %>%
  pivot_longer(cols = !year, names_to = "range", values_to = "Number of children with BLL >= 5 per 1000 tested")

ggplot(data = children_bar, aes(x = year, y=`Number of children with BLL >= 5 per 1000 tested`, fill = factor(range, levels=c("BLL >=15 (mcg/dL)", "10 <= BLL <15 (mcg/dL)", "5 <= BLL <10 (mcg/dL)")))) +
  geom_bar(stat='identity') +
  theme(legend.title = element_blank()) +
  scale_fill_manual(values = c("#F8766D","#7C9B99", "#00BFC4")) +
  ggtitle("Children’s Blood Lead Levels (BLL) in NYC") +
  theme(plot.title = element_text(lineheight=.8, face="bold", hjust = 0.5))
```

We subset our dataset to focus on the blood lead levels (BLL) of children living in New York City. The Centers for Disease Control and Prevention considers a blood lead level over 10 μg/dL abnormal but a level lower than 10 μg/dL might also be harmful. In the stacked bar chart above, we summarize in each year, the number of children with BBL >= 5 μg/dL per 1000 tested. We can observe that the number is decreasing every year. However, there are still many children harmed by lead every year. Therefore, we should attach great importance to the problem of lead contamination in water. 




```{r, warning=FALSE, message=FALSE}
children <- children_6_yrs %>%
  rename(`sample_size(in thousand)` = Children.under.6.years.with.elevated.blood.lead.levels..BLL..Number.Tested, `high_BLL_children_per_1000_tested(sum of 2005-2016)` = Children.under.6.years.with.elevated.blood.lead.levels..BLL..Rate..BLL..5.Âµg.dL.per.1.000.tested) %>%
  select(geo_area_name, `sample_size(in thousand)`, `high_BLL_children_per_1000_tested(sum of 2005-2016)`) %>%
  group_by(geo_area_name) %>%
  summarise(`sample_size(in thousand)` = sum(`sample_size(in thousand)`), `high_BLL_children_per_1000_tested(sum of 2005-2016)` = sum(`high_BLL_children_per_1000_tested(sum of 2005-2016)`))

children$`sample_size(in thousand)` = children$`sample_size(in thousand)` / 1000
children <- children %>% pivot_longer(col = !geo_area_name, names_to = "data_type", values_to = "value")
ggplot(children, aes(value, fct_reorder2(`geo_area_name`, `data_type`=="high_BLL_children_per_1000_tested(sum of 2005-2016)", value, .desc = FALSE), color = data_type)) +
  geom_point() + 
  ggtitle("Sample Size and High BBL Rate Grouped by Area") + 
  theme(legend.position="bottom") +
  theme(axis.text.y = element_text(size = rel(.75))) +
  ylab("") +
  theme(plot.title = element_text(lineheight=.8, face="bold", hjust = 0.5)) + 
  guides(color = guide_legend(nrow = 2))

```

From this Cleveland plots, we can figure out from 2005 to 2016, for each region in New York, how many children under 6 years old in total are tested lead concentration in blood, marked as blue, and among those tested, how many children in total has blood lead level over 5 μg/dL per 1000 tested in , marked as red. The graph will tell us how many children are affected by lead and whether the number of high BLL children per 1000 tested is related to the sample size. The sample size in different regions may differ because population sizes are different and test capabilities are different. We want to figure out if the difference in sample sizes affects the difference in ratio of children with high BLL.

In the graph, regions are sorted by the number of children with high BLL per 1000 tested in an decreasing order. We can observe that as the red points are ordered, blue points are scattered so there is no obvious pattern of relationship between sample size and number of high BLL children. Some regions such as New York City and Queens have large sample sizes but they can still have a low number of high BLL children per 1000 tested. Therefore, the numbers of high BLL children per 1000 tested from different regions are not biased by the difference in sample sizes.

From the plot, we can see that the high BLL rates in different regions differ. Some regions such as Greenpoint and Borough Park has high BLL rates while some regions such as Upper East Side and Willowbrook has much lower BLL rates than other regions. The reason might be that in some places the water pipes and solders contain more lead and government should notice that and replace some of them to guarantee the health of residents.






<!--chapter:end:05-results.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Interactive component

<script src="https://d3js.org/d3.v6.js"></script>

  <div id="my_dataviz">
     
  <p id="change_data">click here to change data<p>
  <p id="change_back">click here to change back<p>
  <p id="note">move your mouse over the dots to see details!<p>

  </div>

<script src="scripts/scatter.js"></script>

<!--chapter:end:06-interactive.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Conclusion


<!--chapter:end:07-conclusion.Rmd-->

